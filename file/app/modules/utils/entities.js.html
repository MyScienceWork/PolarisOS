<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">app/modules/utils/entities.js | AOI</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#initializations">initializations</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-initialize_routes">initialize_routes</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-auth">modules/auth</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-FilterSchema">FilterSchema</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-entities-crud">modules/entities/crud</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/modules/entities/crud/odm.js~ODM.html">ODM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-transform_to_aggregation">transform_to_aggregation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-transform_to_search">transform_to_search</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-transform_to_sort">transform_to_sort</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-entities-crud-controllers">modules/entities/crud/controllers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-count">count</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-del">del</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get">get</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gets">gets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-post">post</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-post_with_action">post_with_action</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-put">put</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-put_with_action">put_with_action</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-search">search</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-exceptions">modules/exceptions</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GenericException">GenericException</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline">modules/pipeline</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/modules/pipeline/pipeline.js~Pipeline.html">Pipeline</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-completer">modules/pipeline/completer</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-complete">complete</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-formatter">modules/pipeline/formatter</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-format">format</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatting">formatting</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-validator">modules/pipeline/validator</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/modules/pipeline/validator/validator.js~Validator.html">Validator</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-utils">modules/utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_signature">generate_signature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_key">generate_key</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_secret">generate_secret</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-count">count</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_cls_from_type">get_cls_from_type</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_info_from_type">get_info_from_type</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_model_from_type">get_model_from_type</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-remove">remove</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-retrieve">retrieve</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-search">search</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-api_middlewares">api_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-app_middlewares">app_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_entity_routes">generate_entity_routes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-koa_middlewares">koa_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_return_inner_object">_return_inner_object</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_test_inner_object">_test_inner_object</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-find_object_with_path">find_object_with_path</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-find_value_with_path">find_value_with_path</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-forge_whitelist_blacklist_query">forge_whitelist_blacklist_query</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hasProperty">hasProperty</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-forge_ok_response">forge_ok_response</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">app/modules/utils/entities.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// @flow
const elasticsearch = require(&apos;elasticsearch&apos;);
const Errors = require(&apos;../exceptions/errors&apos;);
const config = require(&apos;../../config&apos;);
const ODM = require(&apos;../entities/crud/odm&apos;);
const Mapper = require(&apos;../entities/crud/mapper&apos;);

const Publication = require(&apos;../entities/publication/publication&apos;);
const PublicationModel = require(&apos;../entities/publication/models/publications&apos;);

const Citation = require(&apos;../entities/citation/citation&apos;);
const CitationModel = require(&apos;../entities/citation/models/citations&apos;);


type ObjectList = {
    whitelist?: Set&lt;string&gt;,
    blacklist?: Set&lt;string&gt;
};

const es_client = new elasticsearch.Client(config.elasticsearch);

function get_model_from_type(type: string): ?Object {
    switch (type) {
    case &apos;publication&apos;:
        return PublicationModel;
    case &apos;citation&apos;:
        return CitationModel;
    default:
        return null;
    }
}

function get_cls_from_type(type: string): ?Object {
    switch (type) {
    case &apos;publication&apos;:
        return Publication;
    case &apos;citation&apos;:
        return Citation;
    default:
        return null;
    }
}

function get_info_from_type(type: string, id: ?string): ?ODM {
    switch (type) {
    case &apos;publication&apos;:
        return new Publication(es_client, id);
    case &apos;citation&apos;:
        return new Citation(es_client, id);
    default:
        return null;
    }
}

async function create(info: Object, type: string): Promise&lt;*&gt; {
}

async function count(type: string, body: Object): Promise&lt;*&gt; {
    if (type == null) {
        throw Errors.InvalidEntity;
    }

    const cls = get_cls_from_type(type);
    if (cls == null) {
        return { entity: type, count: 0 };
    }

    const s = Mapper.transform_to_search(body, cls.mapping());
    const counting = await cls.count(es_client, s);
    return { entity: type, count: counting.count };
}

async function search(type: string, body: Object): Promise&lt;*&gt; {
    if (type == null) {
        throw Errors.InvalidEntity;
    }

    const cls = get_cls_from_type(type);
    if (cls == null) {
        return { entity: type, result: {} };
    }

    let source = true;
    if (&apos;projection&apos; in body) {
        if (body.projection === false || body.projection === &apos;false&apos;) {
            source = false;
        } else if (body.projection instanceof Array
                &amp;&amp; body.projection.length === 0) {
            source = false;
        } else {
            source = body.projection;
        }
    }

    const options = { source };
    if (&apos;size&apos; in body &amp;&amp; !isNaN(parseInt(body.size, 10))) {
        options.size = body.size;
    }

    if (&apos;from&apos; in body &amp;&amp; !isNaN(parseInt(body.from, 10))) {
        options.from = body.from;
    }

    const s = Mapper.transform_to_search(body, cls.mapping());
    const sort = Mapper.transform_to_sort(body, cls.mapping());
    const aggs = Mapper.transform_to_aggregation(body, cls.mapping());

    if (sort != null &amp;&amp; sort.length &gt; 0) {
        s.add_sort(sort);
    }

    if (aggs != null &amp;&amp; Object.keys(aggs).length &gt; 0) {
        s.add_aggregations(aggs);
    }

    const result = await cls.search(es_client, s, options);
    return { entity: type, result };
}

async function retrieve(id: string, type: string,
        projection: string = &apos;&apos;): Promise&lt;*&gt; {
    if (type == null) {
        return null;
    }

    const odm = get_info_from_type(type, id);

    if (odm == null) {
        return null;
    }

    let _source = true;
    if (projection === &apos;&apos;) {
        _source = true;
    } else if (projection === &apos;false&apos; || projection === false) {
        _source = false;
    } else {
        _source = projection.split(&apos;,&apos;);
    }

    if (_source === true) {
        return odm.get(id);
    }
    return odm.get(id, { source: _source });
}

async function remove(id: string, type: string): Promise&lt;*&gt; {
    if (type == null) {
        return [null, null];
    }

    const odm = get_info_from_type(type);
    if (odm == null) {
        return [null, null];
    }

    const obj = await odm.remove(id);
    return [odm, obj];
}

exports.retrieve = retrieve;
exports.get_info_from_type = get_info_from_type;
exports.get_model_from_type = get_model_from_type;
exports.create = create;
exports.count = count;
exports.search = search;
exports.remove = remove;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.3)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
