<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../">
  <title data-ice="title">app/modules/entities/crud/mapper.js | PolarisOS</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="MyScienceWork provides a suite of data-driven solutions for research institutions, scientific publishers and private-sector R&amp;D companies. MyScienceWork&apos;s comprehensive database includes more than 70 million scientific publications and 12 million patents."><meta property="og:type" content="website"><meta property="og:url" content="https://www.mysciencework.com"><meta property="og:site_name" content="PolarisOS"><meta property="og:title" content="PolarisOS"><meta property="og:image" content="https://www.mysciencework.com/bundles/home/images/logo-primary-medium.png"><meta property="og:description" content="MyScienceWork provides a suite of data-driven solutions for research institutions, scientific publishers and private-sector R&amp;D companies. MyScienceWork&apos;s comprehensive database includes more than 70 million scientific publications and 12 million patents."><meta property="og:author" content="MyScienceWork"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="PolarisOS"><meta property="twitter:description" content="MyScienceWork provides a suite of data-driven solutions for research institutions, scientific publishers and private-sector R&amp;D companies. MyScienceWork&apos;s comprehensive database includes more than 70 million scientific publications and 12 million patents."><meta property="twitter:image" content="https://www.mysciencework.com/bundles/home/images/logo-primary-medium.png"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/MyScienceWork/PolarisOS"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-update">update</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#csl-styles">csl_styles</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add_styles">add_styles</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#initializations">initializations</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-initialize_routes">initialize_routes</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-3rdparty-rss">modules/3rdparty/rss</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_rss_feed">generate_rss_feed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-routes">routes</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-auth">modules/auth</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-FilterSchema">FilterSchema</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-entities-crud">modules/entities/crud</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/modules/entities/crud/odm.js~ODM.html">ODM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_sort">get_sort</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-transform_to_aggregation">transform_to_aggregation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-transform_to_search">transform_to_search</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-transform_to_sort">transform_to_sort</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-entities-crud-controllers">modules/entities/crud/controllers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-count">count</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-del">del</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get">get</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gets">gets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-post">post</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-post_with_action">post_with_action</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-put">put</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-put_with_action">put_with_action</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-search">search</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validate">validate</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-entities-exporter-controllers">modules/entities/exporter/controllers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_author_info">get_author_info</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_edition_stmt">get_edition_stmt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_monogr">get_monogr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_notes_stmt">get_notes_stmt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_profile_desc">get_profile_desc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_publication_stmt">get_publication_stmt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_series_stmt">get_series_stmt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_source_desc">get_source_desc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_title_stmt">get_title_stmt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-transform_publication_to_hal">transform_publication_to_hal</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-entities-mswpublication-controllers">modules/entities/mswpublication/controllers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-send_email">send_email</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-entities-role-controllers">modules/entities/role/controllers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-access">access</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-authenticate">authenticate</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-entities-user-controllers">modules/entities/user/controllers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-access">access</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-authenticate">authenticate</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-entities-user-routes">modules/entities/user/routes</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-routes">routes</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-exceptions">modules/exceptions</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GenericException">GenericException</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline">modules/pipeline</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/modules/pipeline/pipeline.js~Pipeline.html">Pipeline</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-completer">modules/pipeline/completer</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-complete">complete</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-completer-complfunctions">modules/pipeline/completer/complfunctions</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-denormalization">denormalization</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generic_complete">generic_complete</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-initial">initial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-key_complete">key_complete</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-secret_complete">secret_complete</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-formatter">modules/pipeline/formatter</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-format">format</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatting">formatting</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-formatter-formatfunctions">modules/pipeline/formatter/formatfunctions</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-filter_empty_or_null_objects">filter_empty_or_null_objects</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-format_string">format_string</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generic_formatter">generic_formatter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-oarray_to_array">oarray_to_array</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-set_default_lang_for_array">set_default_lang_for_array</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-transformer">modules/pipeline/transformer</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-apply_transducer">apply_transducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-transform">transform</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-transformer-transfunctions">modules/pipeline/transformer/transfunctions</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-flatten">flatten</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_in_list">get_in_list</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-identity">identity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-template_identity">template_identity</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-validator">modules/pipeline/validator</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/modules/pipeline/validator/validator.js~Validator.html">Validator</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-pipeline-validator-valfunctions">modules/pipeline/validator/valfunctions</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-if_exists">if_exists</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-is_conditioned_on">is_conditioned_on</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-is_unique">is_unique</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-is_valid_json">is_valid_json</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#modules-utils">modules/utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cas_auth">cas_auth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-do_standard_checks">do_standard_checks</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-find_through_ldap">find_through_ldap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-find_user">find_user</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_cas_info">get_cas_info</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-login_auth">login_auth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-map_ldap_to_pos">map_ldap_to_pos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-escape_from_bibtex">escape_from_bibtex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-escape_to_bibtex">escape_to_bibtex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_key">generate_key</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_secret">generate_secret</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_config">get_config</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_language_values">get_language_values</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_language_values_from_langs">get_language_values_from_langs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_language_values_from_langs_and_keys">get_language_values_from_langs_and_keys</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-retrieve_single_quantity">retrieve_single_quantity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_smtp_transport">get_smtp_transport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-send_email">send_email</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-send_email_through_smtp">send_email_through_smtp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-send_email_with">send_email_with</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-api_middlewares">api_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-app_middlewares">app_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-del_middlewares">del_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_del_routes">generate_del_routes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_entity_routes">generate_entity_routes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_get_routes">generate_get_routes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_gets_routes">generate_gets_routes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_post_routes">generate_post_routes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generate_put_routes">generate_put_routes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get_middlewares">get_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-koa_middlewares">koa_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-post_middlewares">post_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-put_middlewares">put_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-upload_middlewares">upload_middlewares</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-is_valid_stream">is_valid_stream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-to_array">to_array</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-to_buffer">to_buffer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add_single">add_single</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-download">download</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-multi_download">multi_download</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_return_inner_object">_return_inner_object</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_test_inner_object">_test_inner_object</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-filter_empty_or_null_objects">filter_empty_or_null_objects</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-find_object_with_path">find_object_with_path</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-find_popvalue_with_path">find_popvalue_with_path</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-find_value_with_path">find_value_with_path</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-forge_whitelist_blacklist_query">forge_whitelist_blacklist_query</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hasProperty">hasProperty</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isNil">isNil</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-make_nested_object_from_path">make_nested_object_from_path</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-merge_with_concat">merge_with_concat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-merge_with_replacement">merge_with_replacement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-merge_with_superposition">merge_with_superposition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-traverse_and_execute">traverse_and_execute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-traverse_recreate_and_execute">traverse_recreate_and_execute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-forge_ok_response">forge_ok_response</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-strip_xhtml_tags">strip_xhtml_tags</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-to_object">to_object</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">app/modules/entities/crud/mapper.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const _ = require(&apos;lodash&apos;);
const queries = require(&apos;./query&apos;);
const aggs = require(&apos;./aggregation&apos;);
const Search = require(&apos;./search&apos;);
const errors = require(&apos;../../exceptions/errors&apos;);
const SortOrder = require(&apos;./enums/sort_order&apos;);
const SortMode = require(&apos;./enums/sort_mode&apos;);

function get_sort(sorts) {
    if (!sorts || sorts.length === 0) {
        return [];
    }

    return sorts.map((sort) =&gt; {
        if (_.isString(sort)) {
            const fc = sort[0];
            if (fc === &apos;-&apos;) {
                return { [sort.slice(1)]: &apos;desc&apos; };
            }
            return { [sort]: &apos;asc&apos; };
        }
        return sort;
    });
}

class Mapper {
    static check_wellform_object(obj) {
        const keys = Object.keys(obj);
        const contains_dollars = keys.some(key =&gt; key.startsWith(&apos;$$&apos;));
        const contains_dollar = keys.some(key =&gt; key.startsWith(&apos;$&apos;) &amp;&amp; !key.startsWith(&apos;$$&apos;));
        const contains_shortcut = keys.every(key =&gt; !key.startsWith(&apos;$&apos;));
        return [contains_dollar, contains_dollars, contains_shortcut];
    }

    static auto_nest(types) {
        return types.reduce((acc, elt) =&gt; {
            const [key, parent, type] = elt;
            switch (type) {
            case &apos;nested&apos;: {
                if (acc.length === 0) {
                    const nq = new queries.Nested();
                    acc = [nq, nq];
                } else if (acc[0] instanceof queries.Nested) {
                    const nq = new queries.Nested();
                    acc[1].query(nq);
                    acc[0] = nq;
                }

                if (parent === &apos;&apos;) {
                    acc[0].path(key);
                } else {
                    acc[0].path(`${parent}.${key}`);
                }
                return acc;
            }
            default:
                return acc;
            }
        }, []);
    }

    static raw_query(obj) {
        const keys = Object.keys(obj);
        if (keys[0].startsWith(&apos;$$&apos;)) {
            return new queries.RawQuery({ [keys[0].replace(&apos;$$&apos;, &apos;&apos;)]: obj[keys[0]] });
        }
        return null;
    }

    static make_ids_query(value) {
        if (value instanceof Array) {
            return new queries.Ids({ values: value });
        }
        return new queries.Ids({ values: [value] });
    }

    static shortcut_query(obj, mapping) {
        const keys = Object.keys(obj);
        if (keys.length === 0) {
            return null;
        }

        const key = keys[0];

        if (key === &apos;_id&apos;) {
            return Mapper.make_ids_query(obj[key]);
        }

        const types = mapping.get_all_type(key);
        if (types.length === 0) {
            return null;
        }

        const infos = types[types.length - 1];
        const type = infos[infos.length - 1];
        const value = obj[key];
        let outer_query = null;
        let most_inner_query = null;
        if (types.length &gt; 1) {
            [most_inner_query, outer_query] = Mapper.auto_nest(types);
        }

        if (value instanceof Array) {
            switch (type) {
            case &apos;text&apos;: {
                const matches = value.map((elt) =&gt; {
                    if (elt instanceof Object) {
                        return Mapper.special_shortcut_query(key, type, elt);
                    } else if (elt.startsWith(&apos;&quot;&apos;) &amp;&amp; elt.endsWith(&apos;&quot;&apos;)) {
                        return new queries.MatchPhrase().match({ [key]: elt.slice(1, -1) });
                    }
                    return new queries.Match().match({ [key]: elt });
                }).filter(elt =&gt; elt != null);
                const bool = matches.reduce((q, elt) =&gt; q.should(elt), new queries.Bool());

                if (outer_query != null) {
                    most_inner_query.query(bool);
                    return outer_query;
                }
                return bool;
            }
            case &apos;date&apos;: {
                const range = value.reduce((q, elt) =&gt; q.operators(elt), new queries.Range().field(key));
                if (outer_query != null) {
                    most_inner_query.query(range);
                    return outer_query;
                }
                return range;
            }
            default: {
                const terms = new queries.Terms({ [key]: value });
                if (outer_query != null) {
                    most_inner_query.query(terms);
                    return outer_query;
                }
                return terms;
            }
            }
        } else if (value instanceof Object) {
            const q = Mapper.special_shortcut_query(key, type, value);
            if (q != null &amp;&amp; outer_query != null) {
                most_inner_query.query(q);
                return outer_query;
            }

            if (q == null &amp;&amp; type === &apos;date&apos;) {
                const range = new queries.Range().field(key).operators(value);
                if (outer_query != null) {
                    most_inner_query.query(range);
                    return outer_query;
                }
                return range;
            }
            return q;
        } else {
            switch (type) {
            case &apos;text&apos;: {
                let q = null;
                if (value.startsWith(&apos;&quot;&apos;) &amp;&amp; value.endsWith(&apos;&quot;&apos;)) {
                    q = new queries.MatchPhrase().match({ [key]: value.slice(1, -1) });
                } else {
                    q = new queries.Match().match({ [key]: value });
                }
                if (outer_query != null) {
                    most_inner_query.query(q);
                    return outer_query;
                }
                return q;
            }
            default: {
                const q = new queries.Term({ [key]: value });
                if (outer_query != null) {
                    most_inner_query.query(q);
                    return outer_query;
                }
                return q;
            }
            }
        }
    }

    static special_shortcut_query(key, type, object) {
        if (&apos;$qs&apos; in object) {
            return new queries.QueryString().qs(object.$qs).default_field(key);
        }

        if (&apos;$match&apos; in object &amp;&amp; &apos;query&apos; in object.$match) {
            return new queries.Match(object.$match).match({ [key]: object.$match.query });
        }
        return null;
    }

    static visit_object(obj, mapping) {
        const result = Mapper.check_wellform_object(obj);

        if (result.filter(r =&gt; r === true) &gt;= 2) {
            throw errors.InvalidObject();
        }

        const [contains_dollar, contains_dollars, contains_shortcut] = result;
        if (contains_dollar) {
            return Mapper.bool_query(obj, mapping);
        } else if (contains_dollars) {
            return Mapper.raw_query(obj);
        } else if (contains_shortcut) {
            return Mapper.shortcut_query(obj, mapping);
        }
        return null;
    }

    static visit_bool_query(bool, obj, op, mapping) {
        const result = Mapper.visit_object(obj, mapping);

        switch (op) {
        default:
        case &apos;$and&apos;:
            if (result) {
                bool.must(result);
            }
            break;
        case &apos;$fand&apos;:
            if (result) {
                bool.filter(result);
            }
            break;
        case &apos;$nfand&apos;:
            if (result) {
                bool.must_not(result);
            }
            break;
        case &apos;$or&apos;:
            if (result) {
                bool.should(result);
            }
            break;
        }
        return bool;
    }

    static visit_list(bool, list, op, mapping) {
        list.forEach((obj) =&gt; {
            bool = Mapper.visit_bool_query(bool, obj, op, mapping);
        });
        return bool;
    }


    static bool_query(obj, mapping) {
        let bool = new queries.Bool();
        [&apos;$and&apos;, &apos;$fand&apos;, &apos;$nfand&apos;, &apos;$or&apos;, &apos;$msm&apos;, &apos;$minimum_should_match&apos;].forEach((op) =&gt; {
            if (!(op in obj)) {
                return;
            }

            const val = obj[op];
            if (val instanceof Array) {
                bool = Mapper.visit_list(bool, val, op, mapping);
            } else if (op === &apos;$msm&apos; || op === &apos;$minimum_should_match&apos;) {
                bool.minimum_should_match(val);
            } else {
                bool = Mapper.visit_bool_query(bool, val, op, mapping);
            }
        });
        return bool;
    }
}

class SortMapper {
    static visit_object(sort, mapping) {
        const sorts = sort.map(s =&gt; SortMapper.make_single_sort(s, mapping))
            .filter(s =&gt; s != null);
        return sorts;
    }

    static make_single_sort(sort, mapping) {
        if (typeof sort === &apos;string&apos;) {
            sort = { [sort]: [] };
        }

        const final_sort_obj = {};
        const keys = Object.keys(sort);
        if (keys.length === 0) {
            return null;
        }

        const key = keys[0];

        // We don&apos;t analyze scripted sort
        if (key === &apos;_script&apos;) {
            final_sort_obj[key] = sort[key];
            return final_sort_obj;
        }

        const types = mapping.get_all_type(key);

        const nested_fields = types.filter(elt =&gt; elt[elt.length - 1] === &apos;nested&apos;);
        if (nested_fields.length &gt; 1) {
            return null;
        }

        final_sort_obj[key] = {};

        if (nested_fields.length === 1) {
            final_sort_obj[key].nested_path = nested_fields[0][0];
        }

        const value = sort[key];
        if (value instanceof Array) {
            const tmp = SortMapper.retrieve_mode_and_order(value);
            final_sort_obj[key] = _.merge(final_sort_obj[key], tmp);
        } else {
            const tmp = SortMapper.retrieve_mode_and_order([value]);
            final_sort_obj[key] = _.merge(final_sort_obj[key], tmp);
        }

        return final_sort_obj;
    }

    static retrieve_mode_and_order(array) {
        const final_obj = array.reduce((acc, elt) =&gt; {
            const oen = SortOrder.enumValueOf(elt.toUpperCase());
            if (oen !== undefined) {
                acc.order = oen.toString();
            }
            const men = SortMode.enumValueOf(elt.toUpperCase());
            if (men !== undefined) {
                acc.mode = men.toString();
            }
            return acc;
        }, {});
        return final_obj;
    }
}

class AggregationMapper {
    static auto_nest(types) {
        return types.reduce((acc, elt) =&gt; {
            const [key, parent, type] = elt;
            switch (type) {
            case &apos;nested&apos;: {
                if (acc.length === 0) {
                    const nq = new aggs.NestedAggregation(`${key}_nested`);
                    acc = [nq, nq];
                } else if (acc[0] instanceof aggs.NestedAggregation) {
                    const nq = new aggs.NestedAggregation(`${key}_nested`);
                    acc[1].aggregation(nq);
                    acc[0] = nq;
                }

                if (parent === &apos;&apos;) {
                    acc[0].path(key);
                } else {
                    acc[0].path(`${parent}.${key}`);
                }
                return acc;
            }
            default:
                return acc;
            }
        }, []);
    }

    static check_aggregation_with_required_field(agg_type) {
        switch (agg_type) {
        case &apos;top_hits&apos;:
            return false; // Does not require a field to work
        default:
            return true;
        }
    }


    static visit_object(aggregations, mapping) {
        const a = _.reduce(aggregations, (obj, value, key) =&gt; {
            const agg = AggregationMapper.visit_single_aggregation(key, value, mapping);
            if (agg != null) {
                obj = _.merge(obj, agg.generate());
            }
            return obj;
        }, {});
        return a;
    }

    static visit_single_aggregation(field, aggregation, mapping) {
        if (!(&apos;$type&apos; in aggregation)) {
            return null;
        }

        const type = aggregation.$type;
        const name = aggregation.$name || `${field}_${type}`;

        delete aggregation.$type;
        if (&apos;$name&apos; in aggregation) {
            delete aggregation.$name;
        }

        let most_outer_agg = null;
        if (&apos;$filter&apos; in aggregation) {
            most_outer_agg = new aggs.FilterAggregation(`${field}_filter`).query(aggregation.$filter);
        }

        const types = mapping.get_all_type(field);
        if (types.length === 0 &amp;&amp; AggregationMapper.check_aggregation_with_required_field(type)) {
            return null;
        }


        let most_inner_agg = null;
        let outer_agg = null;
        if (types.length &gt; 1) {
            [most_inner_agg, outer_agg] = AggregationMapper.auto_nest(types);
        }

        let agg = AggregationMapper.forge_aggregation(name, field, type,
                aggregation, mapping);
        if (most_inner_agg != null &amp;&amp; agg != null) {
            most_inner_agg.aggregation(agg);
        }

        if (&apos;$aggregations&apos; in aggregation) {
            const subaggregations = aggregation.$aggregations;
            if (agg instanceof aggs.BucketAggregation) {
                agg = _.reduce(subaggregations,
                        AggregationMapper.visit_subaggregation.bind(null, mapping), agg);
            }
        }

        if (most_outer_agg != null) {
            if (outer_agg != null) {
                most_outer_agg.aggregation(outer_agg);
            } else {
                most_outer_agg.aggregation(agg);
            }
            return most_outer_agg;
        } else if (most_inner_agg != null) {
            return outer_agg;
        }
        return agg;
    }

    static visit_subaggregation(mapping, obj, subvalue, subfield) {
        const subagg = AggregationMapper
                    .visit_single_aggregation(subfield, subvalue, mapping);
        if (subagg != null) {
            obj.aggregation(subagg);
        }
        return obj;
    }


    static forge_aggregation(name, field, type, aggregation, mapping) {
        switch (type) {
        case &apos;min&apos;:
            return new aggs.MinAggregation(name, aggregation).field(field);
        case &apos;avg&apos;:
            return new aggs.AvgAggregation(name, aggregation).field(field);
        case &apos;max&apos;:
            return new aggs.MaxAggregation(name, aggregation).field(field);
        case &apos;sum&apos;:
            return new aggs.SumAggregation(name, aggregation).field(field);
        case &apos;value_count&apos;:
            return new aggs.ValueCountAggregation(name, aggregation).field(field);
        case &apos;cardinality&apos;:
            return new aggs.CardinalityAggregation(name, aggregation).field(field);
        case &apos;terms&apos;:
            return new aggs.TermsAggregation(name, aggregation).field(field);
        case &apos;date_histogram&apos;:
            return new aggs.DateHistogramAggregation(name, aggregation).field(field);
        case &apos;top_hits&apos;:
            if (&apos;sort&apos; in aggregation) {
                const transformed_sort = SortMapper.visit_object(get_sort(aggregation.sort), mapping);
                aggregation.sort = transformed_sort;
            }
            return new aggs.TopHitsAggregation(name, aggregation);
        case &apos;filter&apos;: {
            if (!(&apos;$query&apos; in aggregation)) {
                return null;
            }

            /* let result = Mapper.visit_object(aggregation.$query, mapping);
            if (result == null) {
                result = new queries.MatchAll();
            }*/
            return new aggs.FilterAggregation(name, aggregation).query(aggregation.$query);
        }
        default:
            return null;
        }
    }
}

function transform_to_search(body, mapping) {
    const s = new Search();
    if (!(&apos;where&apos; in body)) {
        s.query(new queries.MatchAll());
        return s;
    }

    const where = body.where;
    const result = Mapper.visit_object(where, mapping);

    if (result) {
        s.query(result);
    } else {
        s.query(new queries.MatchAll());
    }
    return s;
}

function transform_to_sort(body, mapping) {
    if (!(&apos;sort&apos; in body)) {
        return null;
    }

    const sort = body.sort;
    const sort_transformed = get_sort(sort);
    const result = SortMapper.visit_object(sort_transformed, mapping);
    return result;
}

function transform_to_aggregation(body, mapping) {
    if (!(&apos;aggregations&apos; in body)) {
        return null;
    }

    const agg = body.aggregations;
    const result = AggregationMapper.visit_object(agg, mapping);
    return result;
}


module.exports = {
    transform_to_search,
    transform_to_sort,
    transform_to_aggregation,
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
